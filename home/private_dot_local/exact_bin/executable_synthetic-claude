#!/bin/bash
# Claude Code wrapper for synthetic.new

if [ -z "$SYNTHETIC_API_KEY" ]; then
    if command -v pass &>/dev/null; then
        SYNTHETIC_API_KEY=$(pass show api/synthetic.new 2>/dev/null | head -1)
    fi

    if [ -z "$SYNTHETIC_API_KEY" ]; then
        echo "Error: SYNTHETIC_API_KEY not set and could not retrieve from pass." >&2
        echo "Either set SYNTHETIC_API_KEY or run: pass insert api/synthetic.new" >&2
        exit 1
    fi
fi

export CLAUDE_CONFIG_DIR=~/.config/synthetic-claude

# Server configuration
export ANTHROPIC_BASE_URL=https://api.synthetic.new/anthropic
export ANTHROPIC_AUTH_TOKEN=${SYNTHETIC_API_KEY}

# Model configuration
export ANTHROPIC_DEFAULT_OPUS_MODEL=hf:zai-org/GLM-4.7
export ANTHROPIC_DEFAULT_SONNET_MODEL=hf:zai-org/GLM-4.7
export ANTHROPIC_DEFAULT_HAIKU_MODEL=hf:zai-org/GLM-4.7
export CLAUDE_CODE_SUBAGENT_MODEL=hf:zai-org/GLM-4.7

# Privacy configuration
export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1

# Format ISO timestamp to human-readable (convert UTC to local timezone, 12-hour time)
format_time() {
    local iso_time="$1"
    local epoch
    # Parse as UTC to get epoch seconds, then format as local time
    epoch=$(TZ=UTC date -j -f "%Y-%m-%dT%H:%M:%S" "${iso_time%%.*}" "+%s" 2>/dev/null)
    if [ -n "$epoch" ]; then
        date -j -r "$epoch" "+%b %d, %Y at %I:%M:%S %p %Z"
    else
        echo "$iso_time"
    fi
}

# Print quota from JSON response using jq path
print_quota() {
    local name="$1"
    local jq_path="$2"
    local response="$3"
    local used limit renews formatted
    used=$(echo "$response" | jq -r "${jq_path}.requests")
    limit=$(echo "$response" | jq -r "${jq_path}.limit")
    renews=$(echo "$response" | jq -r "${jq_path}.renewsAt")
    formatted=$(format_time "$renews")
    printf "%-16s %s/%s requests used (renews: %s)\n" "$name:" "$used" "$limit" "$formatted"
}

# Handle --quota flag
for arg in "$@"; do
    if [ "$arg" = "--quota" ]; then
        response=$(curl -s https://api.synthetic.new/v2/quotas -H "Authorization: Bearer ${SYNTHETIC_API_KEY}")

        if command -v jq &>/dev/null; then
            print_quota "Subscription" ".subscription" "$response"
            print_quota "Search (hourly)" ".search.hourly" "$response"
            print_quota "Free tool calls" ".freeToolCalls" "$response"
        else
            echo "$response"
        fi
        exit 0
    fi
done

if ! command -v claude &>/dev/null; then
    echo "Error: claude command not found. Please install Claude Code CLI." >&2
    exit 1
fi

# Run claude and wait for it to complete (keeps this script in process list)
claude "$@"
exit $?
