#!/usr/bin/env bash


pnpm=""
pkglock=""
skip_install=""
list=""

if ! command -v "npm" 2>/dev/null 1>/dev/null; then
  echo "npm must be installed to use this" 1>&2 && exit 1
fi

print_help() {
cat <<EOF
  Usage: npmre [--pnpm][--lock][--list]

  > node_modules removal and reinstall for workspaces and beyond

  -h, --help         show this help message
      --pnpm         use pnpm (requires pnpm-workspace.yaml in root for workspaces)
      --lock         remove package-lock.json (will also remove for workspaces)
  -s, --skip-install skip doing the install, just cleanup
  -l, --list         list workspaces and exit without doing anything
EOF

}

while [ $# -gt 0 ]; do
  arg="$1"; shift

  case "$arg" in

    (--help|-h) print_help && exit ;;
    (--pnpm) pnpm="true" ;;
    (--lock|--package-lock|--pkg-lock) pkglock="true" ;;
    (--skip-install|-s|--no-install) skip_install="true" ;;
    (--list|-l) list="true" ;;
    (*) print_help && echo "invalid argument $arg" 1>&2 && exit 1 ;;
  esac
done

if [ -n "$pnpm" ]; then
  if ! command -v "pnpm" 2>/dev/null 1>/dev/null; then
    npm i -g pnpm
  fi
fi


root="$(find-root)"

cd "$root"

DIRS=('.')

if [ "$pnpm" ] && [ -f "./pnpm-workspace.yaml" ]; then
  # Extract packages array from pnpm-workspace.yaml using Node.js
  workspaces="$(node -e "const fs=require('fs');const c=fs.readFileSync('./pnpm-workspace.yaml','utf8');const m=c.match(/^packages:\n((?:  - [^\n]*\n?)*)/m);if(m)m[1].match(/^  - (.+)$/gm).forEach(l=>console.log(l.replace(/^  - /,'')))" 2>/dev/null)"
elif [ -f "./package.json" ]; then
  # Extract workspaces array from package.json using Node.js
  workspaces="$(node -e "const w=require('./package.json').workspaces;w&&w.forEach(x=>console.log(x))")"
fi

if [ -n "$workspaces" ]; then
  while IFS= read -r line; do
    if [ -n "$line" ]; then
      # Expand globs like "packages/*" to actual directories
      for expanded in $line; do
        [ -d "$expanded" ] && DIRS+=("$expanded")
      done
    fi
  done <<< "$workspaces"
fi

if [ -n "$list" ]; then
  for d in "${DIRS[@]}"; do
    echo "$d"
  done
  exit 0
fi

tmpdir="$(mktemp -d)"
mkdir -p "$tmpdir"

for d in "${DIRS[@]}"; do
  if [ -d "$d/node_modules" ]; then
    echo "Removing $d/node_modules"
    mkdir -p "$tmpdir/$d"
    mv "$d/node_modules" "$tmpdir/$d/node_modules"
  fi

  if [ -n "$pkglock" ]; then
    if [ -n "$pnpm" ] && [ -f "$d/pnpm-lock.yaml" ]; then
      echo "Removing $d/pnpm-lock.yaml"
      rm -f "$d/pnpm-lock.yaml"
    elif [ -f "$d/package-lock.json" ]; then
      echo "Removing $d/package-lock.json"
      rm -f "$d/package-lock.json"
    fi
  fi
done

rm -rf "$tmpdir" &
disown

if [ -z "$skip_install" ]; then
  if [ -n "$pnpm" ]; then
    pnpm i
  else
    npm i
  fi
fi
